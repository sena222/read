{"ast":null,"code":"import EventEmitter from \"event-emitter\";\nimport { extend, borders, uuid, isNumber, bounds, defer, createBlobUrl, revokeBlobUrl } from \"../../utils/core\";\nimport EpubCFI from \"../../epubcfi\";\nimport Contents from \"../../contents\";\nimport { EVENTS } from \"../../utils/constants\";\nimport { Pane, Highlight, Underline } from \"marks-pane\";\nclass IframeView {\n  constructor(section, options) {\n    this.settings = extend({\n      ignoreClass: \"\",\n      axis: undefined,\n      //options.layout && options.layout.props.flow === \"scrolled\" ? \"vertical\" : \"horizontal\",\n      direction: undefined,\n      width: 0,\n      height: 0,\n      layout: undefined,\n      globalLayoutProperties: {},\n      method: undefined,\n      forceRight: false,\n      allowScriptedContent: false,\n      allowPopups: false\n    }, options || {});\n    this.id = \"epubjs-view-\" + uuid();\n    this.section = section;\n    this.index = section.index;\n    this.element = this.container(this.settings.axis);\n    this.added = false;\n    this.displayed = false;\n    this.rendered = false;\n\n    // this.width  = this.settings.width;\n    // this.height = this.settings.height;\n\n    this.fixedWidth = 0;\n    this.fixedHeight = 0;\n\n    // Blank Cfi for Parsing\n    this.epubcfi = new EpubCFI();\n    this.layout = this.settings.layout;\n    // Dom events to listen for\n    // this.listenedEvents = [\"keydown\", \"keyup\", \"keypressed\", \"mouseup\", \"mousedown\", \"click\", \"touchend\", \"touchstart\"];\n\n    this.pane = undefined;\n    this.highlights = {};\n    this.underlines = {};\n    this.marks = {};\n  }\n  container(axis) {\n    var element = document.createElement(\"div\");\n    element.classList.add(\"epub-view\");\n\n    // this.element.style.minHeight = \"100px\";\n    element.style.height = \"0px\";\n    element.style.width = \"0px\";\n    element.style.overflow = \"hidden\";\n    element.style.position = \"relative\";\n    element.style.display = \"block\";\n    if (axis && axis == \"horizontal\") {\n      element.style.flex = \"none\";\n    } else {\n      element.style.flex = \"initial\";\n    }\n    return element;\n  }\n  create() {\n    if (this.iframe) {\n      return this.iframe;\n    }\n    if (!this.element) {\n      this.element = this.createContainer();\n    }\n    this.iframe = document.createElement(\"iframe\");\n    this.iframe.id = this.id;\n    this.iframe.scrolling = \"no\"; // Might need to be removed: breaks ios width calculations\n    this.iframe.style.overflow = \"hidden\";\n    this.iframe.seamless = \"seamless\";\n    // Back up if seamless isn't supported\n    this.iframe.style.border = \"none\";\n\n    // sandbox\n    this.iframe.sandbox = \"allow-same-origin\";\n    if (this.settings.allowScriptedContent) {\n      this.iframe.sandbox += \" allow-scripts\";\n    }\n    if (this.settings.allowPopups) {\n      this.iframe.sandbox += \" allow-popups\";\n    }\n    this.iframe.setAttribute(\"enable-annotation\", \"true\");\n    this.resizing = true;\n\n    // this.iframe.style.display = \"none\";\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.iframe.style.width = \"0\";\n    this.iframe.style.height = \"0\";\n    this._width = 0;\n    this._height = 0;\n    this.element.setAttribute(\"ref\", this.index);\n    this.added = true;\n    this.elementBounds = bounds(this.element);\n\n    // if(width || height){\n    //   this.resize(width, height);\n    // } else if(this.width && this.height){\n    //   this.resize(this.width, this.height);\n    // } else {\n    //   this.iframeBounds = bounds(this.iframe);\n    // }\n\n    if (\"srcdoc\" in this.iframe) {\n      this.supportsSrcdoc = true;\n    } else {\n      this.supportsSrcdoc = false;\n    }\n    if (!this.settings.method) {\n      this.settings.method = this.supportsSrcdoc ? \"srcdoc\" : \"write\";\n    }\n    return this.iframe;\n  }\n  render(request, show) {\n    // view.onLayout = this.layout.format.bind(this.layout);\n    this.create();\n\n    // Fit to size of the container, apply padding\n    this.size();\n    if (!this.sectionRender) {\n      this.sectionRender = this.section.render(request);\n    }\n\n    // Render Chain\n    return this.sectionRender.then(function (contents) {\n      return this.load(contents);\n    }.bind(this)).then(function () {\n      // find and report the writingMode axis\n      let writingMode = this.contents.writingMode();\n\n      // Set the axis based on the flow and writing mode\n      let axis;\n      if (this.settings.flow === \"scrolled\") {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"horizontal\" : \"vertical\";\n      } else {\n        axis = writingMode.indexOf(\"vertical\") === 0 ? \"vertical\" : \"horizontal\";\n      }\n      if (writingMode.indexOf(\"vertical\") === 0 && this.settings.flow === \"paginated\") {\n        this.layout.delta = this.layout.height;\n      }\n      this.setAxis(axis);\n      this.emit(EVENTS.VIEWS.AXIS, axis);\n      this.setWritingMode(writingMode);\n      this.emit(EVENTS.VIEWS.WRITING_MODE, writingMode);\n\n      // apply the layout function to the contents\n      this.layout.format(this.contents, this.section, this.axis);\n\n      // Listen for events that require an expansion of the iframe\n      this.addListeners();\n      return new Promise((resolve, reject) => {\n        // Expand the iframe to the full size of the content\n        this.expand();\n        if (this.settings.forceRight) {\n          this.element.style.marginLeft = this.width() + \"px\";\n        }\n        resolve();\n      });\n    }.bind(this), function (e) {\n      this.emit(EVENTS.VIEWS.LOAD_ERROR, e);\n      return new Promise((resolve, reject) => {\n        reject(e);\n      });\n    }.bind(this)).then(function () {\n      this.emit(EVENTS.VIEWS.RENDERED, this.section);\n    }.bind(this));\n  }\n  reset() {\n    if (this.iframe) {\n      this.iframe.style.width = \"0\";\n      this.iframe.style.height = \"0\";\n      this._width = 0;\n      this._height = 0;\n      this._textWidth = undefined;\n      this._contentWidth = undefined;\n      this._textHeight = undefined;\n      this._contentHeight = undefined;\n    }\n    this._needsReframe = true;\n  }\n\n  // Determine locks base on settings\n  size(_width, _height) {\n    var width = _width || this.settings.width;\n    var height = _height || this.settings.height;\n    if (this.layout.name === \"pre-paginated\") {\n      this.lock(\"both\", width, height);\n    } else if (this.settings.axis === \"horizontal\") {\n      this.lock(\"height\", width, height);\n    } else {\n      this.lock(\"width\", width, height);\n    }\n    this.settings.width = width;\n    this.settings.height = height;\n  }\n\n  // Lock an axis to element dimensions, taking borders into account\n  lock(what, width, height) {\n    var elBorders = borders(this.element);\n    var iframeBorders;\n    if (this.iframe) {\n      iframeBorders = borders(this.iframe);\n    } else {\n      iframeBorders = {\n        width: 0,\n        height: 0\n      };\n    }\n    if (what == \"width\" && isNumber(width)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width;\n      // this.resize(this.lockedWidth, width); //  width keeps ratio correct\n    }\n\n    if (what == \"height\" && isNumber(height)) {\n      this.lockedHeight = height - elBorders.height - iframeBorders.height;\n      // this.resize(width, this.lockedHeight);\n    }\n\n    if (what === \"both\" && isNumber(width) && isNumber(height)) {\n      this.lockedWidth = width - elBorders.width - iframeBorders.width;\n      this.lockedHeight = height - elBorders.height - iframeBorders.height;\n      // this.resize(this.lockedWidth, this.lockedHeight);\n    }\n\n    if (this.displayed && this.iframe) {\n      // this.contents.layout();\n      this.expand();\n    }\n  }\n\n  // Resize a single axis based on content dimensions\n  expand(force) {\n    var width = this.lockedWidth;\n    var height = this.lockedHeight;\n    var columns;\n    var textWidth, textHeight;\n    if (!this.iframe || this._expanding) return;\n    this._expanding = true;\n    if (this.layout.name === \"pre-paginated\") {\n      width = this.layout.columnWidth;\n      height = this.layout.height;\n    }\n    // Expand Horizontally\n    else if (this.settings.axis === \"horizontal\") {\n      // Get the width of the text\n      width = this.contents.textWidth();\n      if (width % this.layout.pageWidth > 0) {\n        width = Math.ceil(width / this.layout.pageWidth) * this.layout.pageWidth;\n      }\n      if (this.settings.forceEvenPages) {\n        columns = width / this.layout.pageWidth;\n        if (this.layout.divisor > 1 && this.layout.name === \"reflowable\" && columns % 2 > 0) {\n          // add a blank page\n          width += this.layout.pageWidth;\n        }\n      }\n    } // Expand Vertically\n    else if (this.settings.axis === \"vertical\") {\n      height = this.contents.textHeight();\n      if (this.settings.flow === \"paginated\" && height % this.layout.height > 0) {\n        height = Math.ceil(height / this.layout.height) * this.layout.height;\n      }\n    }\n\n    // Only Resize if dimensions have changed or\n    // if Frame is still hidden, so needs reframing\n    if (this._needsReframe || width != this._width || height != this._height) {\n      this.reframe(width, height);\n    }\n    this._expanding = false;\n  }\n  reframe(width, height) {\n    var size;\n    if (isNumber(width)) {\n      this.element.style.width = width + \"px\";\n      this.iframe.style.width = width + \"px\";\n      this._width = width;\n    }\n    if (isNumber(height)) {\n      this.element.style.height = height + \"px\";\n      this.iframe.style.height = height + \"px\";\n      this._height = height;\n    }\n    let widthDelta = this.prevBounds ? width - this.prevBounds.width : width;\n    let heightDelta = this.prevBounds ? height - this.prevBounds.height : height;\n    size = {\n      width: width,\n      height: height,\n      widthDelta: widthDelta,\n      heightDelta: heightDelta\n    };\n    this.pane && this.pane.render();\n    requestAnimationFrame(() => {\n      let mark;\n      for (let m in this.marks) {\n        if (this.marks.hasOwnProperty(m)) {\n          mark = this.marks[m];\n          this.placeMark(mark.element, mark.range);\n        }\n      }\n    });\n    this.onResize(this, size);\n    this.emit(EVENTS.VIEWS.RESIZED, size);\n    this.prevBounds = size;\n    this.elementBounds = bounds(this.element);\n  }\n  load(contents) {\n    var loading = new defer();\n    var loaded = loading.promise;\n    if (!this.iframe) {\n      loading.reject(new Error(\"No Iframe Available\"));\n      return loaded;\n    }\n    this.iframe.onload = function (event) {\n      this.onLoad(event, loading);\n    }.bind(this);\n    if (this.settings.method === \"blobUrl\") {\n      this.blobUrl = createBlobUrl(contents, \"application/xhtml+xml\");\n      this.iframe.src = this.blobUrl;\n      this.element.appendChild(this.iframe);\n    } else if (this.settings.method === \"srcdoc\") {\n      this.iframe.srcdoc = contents;\n      this.element.appendChild(this.iframe);\n    } else {\n      this.element.appendChild(this.iframe);\n      this.document = this.iframe.contentDocument;\n      if (!this.document) {\n        loading.reject(new Error(\"No Document Available\"));\n        return loaded;\n      }\n      this.iframe.contentDocument.open();\n      // For Cordova windows platform\n      if (window.MSApp && MSApp.execUnsafeLocalFunction) {\n        var outerThis = this;\n        MSApp.execUnsafeLocalFunction(function () {\n          outerThis.iframe.contentDocument.write(contents);\n        });\n      } else {\n        this.iframe.contentDocument.write(contents);\n      }\n      this.iframe.contentDocument.close();\n    }\n    return loaded;\n  }\n  onLoad(event, promise) {\n    this.window = this.iframe.contentWindow;\n    this.document = this.iframe.contentDocument;\n    this.contents = new Contents(this.document, this.document.body, this.section.cfiBase, this.section.index);\n    this.rendering = false;\n    var link = this.document.querySelector(\"link[rel='canonical']\");\n    if (link) {\n      link.setAttribute(\"href\", this.section.canonical);\n    } else {\n      link = this.document.createElement(\"link\");\n      link.setAttribute(\"rel\", \"canonical\");\n      link.setAttribute(\"href\", this.section.canonical);\n      this.document.querySelector(\"head\").appendChild(link);\n    }\n    this.contents.on(EVENTS.CONTENTS.EXPAND, () => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    this.contents.on(EVENTS.CONTENTS.RESIZE, e => {\n      if (this.displayed && this.iframe) {\n        this.expand();\n        if (this.contents) {\n          this.layout.format(this.contents);\n        }\n      }\n    });\n    promise.resolve(this.contents);\n  }\n  setLayout(layout) {\n    this.layout = layout;\n    if (this.contents) {\n      this.layout.format(this.contents);\n      this.expand();\n    }\n  }\n  setAxis(axis) {\n    this.settings.axis = axis;\n    if (axis == \"horizontal\") {\n      this.element.style.flex = \"none\";\n    } else {\n      this.element.style.flex = \"initial\";\n    }\n    this.size();\n  }\n  setWritingMode(mode) {\n    // this.element.style.writingMode = writingMode;\n    this.writingMode = mode;\n  }\n  addListeners() {\n    //TODO: Add content listeners for expanding\n  }\n  removeListeners(layoutFunc) {\n    //TODO: remove content listeners for expanding\n  }\n  display(request) {\n    var displayed = new defer();\n    if (!this.displayed) {\n      this.render(request).then(function () {\n        this.emit(EVENTS.VIEWS.DISPLAYED, this);\n        this.onDisplayed(this);\n        this.displayed = true;\n        displayed.resolve(this);\n      }.bind(this), function (err) {\n        displayed.reject(err, this);\n      });\n    } else {\n      displayed.resolve(this);\n    }\n    return displayed.promise;\n  }\n  show() {\n    this.element.style.visibility = \"visible\";\n    if (this.iframe) {\n      this.iframe.style.visibility = \"visible\";\n\n      // Remind Safari to redraw the iframe\n      this.iframe.style.transform = \"translateZ(0)\";\n      this.iframe.offsetWidth;\n      this.iframe.style.transform = null;\n    }\n    this.emit(EVENTS.VIEWS.SHOWN, this);\n  }\n  hide() {\n    // this.iframe.style.display = \"none\";\n    this.element.style.visibility = \"hidden\";\n    this.iframe.style.visibility = \"hidden\";\n    this.stopExpanding = true;\n    this.emit(EVENTS.VIEWS.HIDDEN, this);\n  }\n  offset() {\n    return {\n      top: this.element.offsetTop,\n      left: this.element.offsetLeft\n    };\n  }\n  width() {\n    return this._width;\n  }\n  height() {\n    return this._height;\n  }\n  position() {\n    return this.element.getBoundingClientRect();\n  }\n  locationOf(target) {\n    var parentPos = this.iframe.getBoundingClientRect();\n    var targetPos = this.contents.locationOf(target, this.settings.ignoreClass);\n    return {\n      \"left\": targetPos.left,\n      \"top\": targetPos.top\n    };\n  }\n  onDisplayed(view) {\n    // Stub, override with a custom functions\n  }\n  onResize(view, e) {\n    // Stub, override with a custom functions\n  }\n  bounds(force) {\n    if (force || !this.elementBounds) {\n      this.elementBounds = bounds(this.element);\n    }\n    return this.elementBounds;\n  }\n  highlight(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n    let className = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : \"epubjs-hl\";\n    let styles = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};\n    if (!this.contents) {\n      return;\n    }\n    const attributes = Object.assign({\n      \"fill\": \"yellow\",\n      \"fill-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n    let emitter = () => {\n      this.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n    data[\"epubcfi\"] = cfiRange;\n    if (!this.pane) {\n      this.pane = new Pane(this.iframe, this.element);\n    }\n    let m = new Highlight(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.highlights[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n    return h;\n  }\n  underline(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n    let className = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : \"epubjs-ul\";\n    let styles = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};\n    if (!this.contents) {\n      return;\n    }\n    const attributes = Object.assign({\n      \"stroke\": \"black\",\n      \"stroke-opacity\": \"0.3\",\n      \"mix-blend-mode\": \"multiply\"\n    }, styles);\n    let range = this.contents.range(cfiRange);\n    let emitter = () => {\n      this.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n    data[\"epubcfi\"] = cfiRange;\n    if (!this.pane) {\n      this.pane = new Pane(this.iframe, this.element);\n    }\n    let m = new Underline(range, className, data, attributes);\n    let h = this.pane.addMark(m);\n    this.underlines[cfiRange] = {\n      \"mark\": h,\n      \"element\": h.element,\n      \"listeners\": [emitter, cb]\n    };\n    h.element.setAttribute(\"ref\", className);\n    h.element.addEventListener(\"click\", emitter);\n    h.element.addEventListener(\"touchstart\", emitter);\n    if (cb) {\n      h.element.addEventListener(\"click\", cb);\n      h.element.addEventListener(\"touchstart\", cb);\n    }\n    return h;\n  }\n  mark(cfiRange) {\n    let data = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    let cb = arguments.length > 2 ? arguments[2] : undefined;\n    if (!this.contents) {\n      return;\n    }\n    if (cfiRange in this.marks) {\n      let item = this.marks[cfiRange];\n      return item;\n    }\n    let range = this.contents.range(cfiRange);\n    if (!range) {\n      return;\n    }\n    let container = range.commonAncestorContainer;\n    let parent = container.nodeType === 1 ? container : container.parentNode;\n    let emitter = e => {\n      this.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n    };\n    if (range.collapsed && container.nodeType === 1) {\n      range = new Range();\n      range.selectNodeContents(container);\n    } else if (range.collapsed) {\n      // Webkit doesn't like collapsed ranges\n      range = new Range();\n      range.selectNodeContents(parent);\n    }\n    let mark = this.document.createElement(\"a\");\n    mark.setAttribute(\"ref\", \"epubjs-mk\");\n    mark.style.position = \"absolute\";\n    mark.dataset[\"epubcfi\"] = cfiRange;\n    if (data) {\n      Object.keys(data).forEach(key => {\n        mark.dataset[key] = data[key];\n      });\n    }\n    if (cb) {\n      mark.addEventListener(\"click\", cb);\n      mark.addEventListener(\"touchstart\", cb);\n    }\n    mark.addEventListener(\"click\", emitter);\n    mark.addEventListener(\"touchstart\", emitter);\n    this.placeMark(mark, range);\n    this.element.appendChild(mark);\n    this.marks[cfiRange] = {\n      \"element\": mark,\n      \"range\": range,\n      \"listeners\": [emitter, cb]\n    };\n    return parent;\n  }\n  placeMark(element, range) {\n    let top, right, left;\n    if (this.layout.name === \"pre-paginated\" || this.settings.axis !== \"horizontal\") {\n      let pos = range.getBoundingClientRect();\n      top = pos.top;\n      right = pos.right;\n    } else {\n      // Element might break columns, so find the left most element\n      let rects = range.getClientRects();\n      let rect;\n      for (var i = 0; i != rects.length; i++) {\n        rect = rects[i];\n        if (!left || rect.left < left) {\n          left = rect.left;\n          // right = rect.right;\n          right = Math.ceil(left / this.layout.props.pageWidth) * this.layout.props.pageWidth - this.layout.gap / 2;\n          top = rect.top;\n        }\n      }\n    }\n    element.style.top = `${top}px`;\n    element.style.left = `${right}px`;\n  }\n  unhighlight(cfiRange) {\n    let item;\n    if (cfiRange in this.highlights) {\n      item = this.highlights[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n        ;\n      });\n      delete this.highlights[cfiRange];\n    }\n  }\n  ununderline(cfiRange) {\n    let item;\n    if (cfiRange in this.underlines) {\n      item = this.underlines[cfiRange];\n      this.pane.removeMark(item.mark);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n        ;\n      });\n      delete this.underlines[cfiRange];\n    }\n  }\n  unmark(cfiRange) {\n    let item;\n    if (cfiRange in this.marks) {\n      item = this.marks[cfiRange];\n      this.element.removeChild(item.element);\n      item.listeners.forEach(l => {\n        if (l) {\n          item.element.removeEventListener(\"click\", l);\n          item.element.removeEventListener(\"touchstart\", l);\n        }\n        ;\n      });\n      delete this.marks[cfiRange];\n    }\n  }\n  destroy() {\n    for (let cfiRange in this.highlights) {\n      this.unhighlight(cfiRange);\n    }\n    for (let cfiRange in this.underlines) {\n      this.ununderline(cfiRange);\n    }\n    for (let cfiRange in this.marks) {\n      this.unmark(cfiRange);\n    }\n    if (this.blobUrl) {\n      revokeBlobUrl(this.blobUrl);\n    }\n    if (this.displayed) {\n      this.displayed = false;\n      this.removeListeners();\n      this.contents.destroy();\n      this.stopExpanding = true;\n      this.element.removeChild(this.iframe);\n      if (this.pane) {\n        this.pane.element.remove();\n        this.pane = undefined;\n      }\n      this.iframe = undefined;\n      this.contents = undefined;\n      this._textWidth = null;\n      this._textHeight = null;\n      this._width = null;\n      this._height = null;\n    }\n\n    // this.element.style.height = \"0px\";\n    // this.element.style.width = \"0px\";\n  }\n}\n\nEventEmitter(IframeView.prototype);\nexport default IframeView;","map":{"version":3,"names":["EventEmitter","extend","borders","uuid","isNumber","bounds","defer","createBlobUrl","revokeBlobUrl","EpubCFI","Contents","EVENTS","Pane","Highlight","Underline","IframeView","constructor","section","options","settings","ignoreClass","axis","undefined","direction","width","height","layout","globalLayoutProperties","method","forceRight","allowScriptedContent","allowPopups","id","index","element","container","added","displayed","rendered","fixedWidth","fixedHeight","epubcfi","pane","highlights","underlines","marks","document","createElement","classList","add","style","overflow","position","display","flex","create","iframe","createContainer","scrolling","seamless","border","sandbox","setAttribute","resizing","visibility","_width","_height","elementBounds","supportsSrcdoc","render","request","show","size","sectionRender","then","contents","load","bind","writingMode","flow","indexOf","delta","setAxis","emit","VIEWS","AXIS","setWritingMode","WRITING_MODE","format","addListeners","Promise","resolve","reject","expand","marginLeft","e","LOAD_ERROR","RENDERED","reset","_textWidth","_contentWidth","_textHeight","_contentHeight","_needsReframe","name","lock","what","elBorders","iframeBorders","lockedWidth","lockedHeight","force","columns","textWidth","textHeight","_expanding","columnWidth","pageWidth","Math","ceil","forceEvenPages","divisor","reframe","widthDelta","prevBounds","heightDelta","requestAnimationFrame","mark","m","hasOwnProperty","placeMark","range","onResize","RESIZED","loading","loaded","promise","Error","onload","event","onLoad","blobUrl","src","appendChild","srcdoc","contentDocument","open","window","MSApp","execUnsafeLocalFunction","outerThis","write","close","contentWindow","body","cfiBase","rendering","link","querySelector","canonical","on","CONTENTS","EXPAND","RESIZE","setLayout","mode","removeListeners","layoutFunc","DISPLAYED","onDisplayed","err","transform","offsetWidth","SHOWN","hide","stopExpanding","HIDDEN","offset","top","offsetTop","left","offsetLeft","getBoundingClientRect","locationOf","target","parentPos","targetPos","view","highlight","cfiRange","data","cb","className","styles","attributes","Object","assign","emitter","MARK_CLICKED","h","addMark","addEventListener","underline","item","commonAncestorContainer","parent","nodeType","parentNode","collapsed","Range","selectNodeContents","dataset","keys","forEach","key","right","pos","rects","getClientRects","rect","i","length","props","gap","unhighlight","removeMark","listeners","l","removeEventListener","ununderline","unmark","removeChild","destroy","remove","prototype"],"sources":["/home/parallels/Downloads/react-epub-viewer-demo/node_modules/epubjs/src/managers/views/iframe.js"],"sourcesContent":["import EventEmitter from \"event-emitter\";\nimport {extend, borders, uuid, isNumber, bounds, defer, createBlobUrl, revokeBlobUrl} from \"../../utils/core\";\nimport EpubCFI from \"../../epubcfi\";\nimport Contents from \"../../contents\";\nimport { EVENTS } from \"../../utils/constants\";\nimport { Pane, Highlight, Underline } from \"marks-pane\";\n\nclass IframeView {\n\tconstructor(section, options) {\n\t\tthis.settings = extend({\n\t\t\tignoreClass : \"\",\n\t\t\taxis: undefined, //options.layout && options.layout.props.flow === \"scrolled\" ? \"vertical\" : \"horizontal\",\n\t\t\tdirection: undefined,\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t\tlayout: undefined,\n\t\t\tglobalLayoutProperties: {},\n\t\t\tmethod: undefined,\n\t\t\tforceRight: false,\n\t\t\tallowScriptedContent: false,\n\t\t\tallowPopups: false\n\t\t}, options || {});\n\n\t\tthis.id = \"epubjs-view-\" + uuid();\n\t\tthis.section = section;\n\t\tthis.index = section.index;\n\n\t\tthis.element = this.container(this.settings.axis);\n\n\t\tthis.added = false;\n\t\tthis.displayed = false;\n\t\tthis.rendered = false;\n\n\t\t// this.width  = this.settings.width;\n\t\t// this.height = this.settings.height;\n\n\t\tthis.fixedWidth  = 0;\n\t\tthis.fixedHeight = 0;\n\n\t\t// Blank Cfi for Parsing\n\t\tthis.epubcfi = new EpubCFI();\n\n\t\tthis.layout = this.settings.layout;\n\t\t// Dom events to listen for\n\t\t// this.listenedEvents = [\"keydown\", \"keyup\", \"keypressed\", \"mouseup\", \"mousedown\", \"click\", \"touchend\", \"touchstart\"];\n\n\t\tthis.pane = undefined;\n\t\tthis.highlights = {};\n\t\tthis.underlines = {};\n\t\tthis.marks = {};\n\n\t}\n\n\tcontainer(axis) {\n\t\tvar element = document.createElement(\"div\");\n\n\t\telement.classList.add(\"epub-view\");\n\n\t\t// this.element.style.minHeight = \"100px\";\n\t\telement.style.height = \"0px\";\n\t\telement.style.width = \"0px\";\n\t\telement.style.overflow = \"hidden\";\n\t\telement.style.position = \"relative\";\n\t\telement.style.display = \"block\";\n\n\t\tif(axis && axis == \"horizontal\"){\n\t\t\telement.style.flex = \"none\";\n\t\t} else {\n\t\t\telement.style.flex = \"initial\";\n\t\t}\n\n\t\treturn element;\n\t}\n\n\tcreate() {\n\n\t\tif(this.iframe) {\n\t\t\treturn this.iframe;\n\t\t}\n\n\t\tif(!this.element) {\n\t\t\tthis.element = this.createContainer();\n\t\t}\n\n\t\tthis.iframe = document.createElement(\"iframe\");\n\t\tthis.iframe.id = this.id;\n\t\tthis.iframe.scrolling = \"no\"; // Might need to be removed: breaks ios width calculations\n\t\tthis.iframe.style.overflow = \"hidden\";\n\t\tthis.iframe.seamless = \"seamless\";\n\t\t// Back up if seamless isn't supported\n\t\tthis.iframe.style.border = \"none\";\n\n\t\t// sandbox\n\t\tthis.iframe.sandbox = \"allow-same-origin\";\n\t\tif (this.settings.allowScriptedContent) {\n\t\t\tthis.iframe.sandbox += \" allow-scripts\";\n\t\t}\n\t\tif (this.settings.allowPopups) {\n\t\t\tthis.iframe.sandbox += \" allow-popups\";\n\t\t}\n\t\t\n\t\tthis.iframe.setAttribute(\"enable-annotation\", \"true\");\n\n\t\tthis.resizing = true;\n\n\t\t// this.iframe.style.display = \"none\";\n\t\tthis.element.style.visibility = \"hidden\";\n\t\tthis.iframe.style.visibility = \"hidden\";\n\n\t\tthis.iframe.style.width = \"0\";\n\t\tthis.iframe.style.height = \"0\";\n\t\tthis._width = 0;\n\t\tthis._height = 0;\n\n\t\tthis.element.setAttribute(\"ref\", this.index);\n\n\t\tthis.added = true;\n\n\t\tthis.elementBounds = bounds(this.element);\n\n\t\t// if(width || height){\n\t\t//   this.resize(width, height);\n\t\t// } else if(this.width && this.height){\n\t\t//   this.resize(this.width, this.height);\n\t\t// } else {\n\t\t//   this.iframeBounds = bounds(this.iframe);\n\t\t// }\n\n\n\t\tif((\"srcdoc\" in this.iframe)) {\n\t\t\tthis.supportsSrcdoc = true;\n\t\t} else {\n\t\t\tthis.supportsSrcdoc = false;\n\t\t}\n\n\t\tif (!this.settings.method) {\n\t\t\tthis.settings.method = this.supportsSrcdoc ? \"srcdoc\" : \"write\";\n\t\t}\n\n\t\treturn this.iframe;\n\t}\n\n\trender(request, show) {\n\n\t\t// view.onLayout = this.layout.format.bind(this.layout);\n\t\tthis.create();\n\n\t\t// Fit to size of the container, apply padding\n\t\tthis.size();\n\n\t\tif(!this.sectionRender) {\n\t\t\tthis.sectionRender = this.section.render(request);\n\t\t}\n\n\t\t// Render Chain\n\t\treturn this.sectionRender\n\t\t\t.then(function(contents){\n\t\t\t\treturn this.load(contents);\n\t\t\t}.bind(this))\n\t\t\t.then(function(){\n\n\t\t\t\t// find and report the writingMode axis\n\t\t\t\tlet writingMode = this.contents.writingMode();\n\n\t\t\t\t// Set the axis based on the flow and writing mode\n\t\t\t\tlet axis;\n\t\t\t\tif (this.settings.flow === \"scrolled\") {\n\t\t\t\t\taxis = (writingMode.indexOf(\"vertical\") === 0) ? \"horizontal\" : \"vertical\";\n\t\t\t\t} else {\n\t\t\t\t\taxis = (writingMode.indexOf(\"vertical\") === 0) ? \"vertical\" : \"horizontal\";\n\t\t\t\t}\n\n\t\t\t\tif (writingMode.indexOf(\"vertical\") === 0 && this.settings.flow === \"paginated\") {\n\t\t\t\t\tthis.layout.delta = this.layout.height;\n\t\t\t\t}\n\n\t\t\t\tthis.setAxis(axis);\n\t\t\t\tthis.emit(EVENTS.VIEWS.AXIS, axis);\n\n\t\t\t\tthis.setWritingMode(writingMode);\n\t\t\t\tthis.emit(EVENTS.VIEWS.WRITING_MODE, writingMode);\n\n\n\t\t\t\t// apply the layout function to the contents\n\t\t\t\tthis.layout.format(this.contents, this.section, this.axis);\n\n\t\t\t\t// Listen for events that require an expansion of the iframe\n\t\t\t\tthis.addListeners();\n\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\t// Expand the iframe to the full size of the content\n\t\t\t\t\tthis.expand();\n\n\t\t\t\t\tif (this.settings.forceRight) {\n\t\t\t\t\t\tthis.element.style.marginLeft = this.width() + \"px\";\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\n\t\t\t}.bind(this), function(e){\n\t\t\t\tthis.emit(EVENTS.VIEWS.LOAD_ERROR, e);\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\treject(e);\n\t\t\t\t});\n\t\t\t}.bind(this))\n\t\t\t.then(function() {\n\t\t\t\tthis.emit(EVENTS.VIEWS.RENDERED, this.section);\n\t\t\t}.bind(this));\n\n\t}\n\n\treset () {\n\t\tif (this.iframe) {\n\t\t\tthis.iframe.style.width = \"0\";\n\t\t\tthis.iframe.style.height = \"0\";\n\t\t\tthis._width = 0;\n\t\t\tthis._height = 0;\n\t\t\tthis._textWidth = undefined;\n\t\t\tthis._contentWidth = undefined;\n\t\t\tthis._textHeight = undefined;\n\t\t\tthis._contentHeight = undefined;\n\t\t}\n\t\tthis._needsReframe = true;\n\t}\n\n\t// Determine locks base on settings\n\tsize(_width, _height) {\n\t\tvar width = _width || this.settings.width;\n\t\tvar height = _height || this.settings.height;\n\n\t\tif(this.layout.name === \"pre-paginated\") {\n\t\t\tthis.lock(\"both\", width, height);\n\t\t} else if(this.settings.axis === \"horizontal\") {\n\t\t\tthis.lock(\"height\", width, height);\n\t\t} else {\n\t\t\tthis.lock(\"width\", width, height);\n\t\t}\n\n\t\tthis.settings.width = width;\n\t\tthis.settings.height = height;\n\t}\n\n\t// Lock an axis to element dimensions, taking borders into account\n\tlock(what, width, height) {\n\t\tvar elBorders = borders(this.element);\n\t\tvar iframeBorders;\n\n\t\tif(this.iframe) {\n\t\t\tiframeBorders = borders(this.iframe);\n\t\t} else {\n\t\t\tiframeBorders = {width: 0, height: 0};\n\t\t}\n\n\t\tif(what == \"width\" && isNumber(width)){\n\t\t\tthis.lockedWidth = width - elBorders.width - iframeBorders.width;\n\t\t\t// this.resize(this.lockedWidth, width); //  width keeps ratio correct\n\t\t}\n\n\t\tif(what == \"height\" && isNumber(height)){\n\t\t\tthis.lockedHeight = height - elBorders.height - iframeBorders.height;\n\t\t\t// this.resize(width, this.lockedHeight);\n\t\t}\n\n\t\tif(what === \"both\" &&\n\t\t\t isNumber(width) &&\n\t\t\t isNumber(height)){\n\n\t\t\tthis.lockedWidth = width - elBorders.width - iframeBorders.width;\n\t\t\tthis.lockedHeight = height - elBorders.height - iframeBorders.height;\n\t\t\t// this.resize(this.lockedWidth, this.lockedHeight);\n\t\t}\n\n\t\tif(this.displayed && this.iframe) {\n\n\t\t\t// this.contents.layout();\n\t\t\tthis.expand();\n\t\t}\n\n\n\n\t}\n\n\t// Resize a single axis based on content dimensions\n\texpand(force) {\n\t\tvar width = this.lockedWidth;\n\t\tvar height = this.lockedHeight;\n\t\tvar columns;\n\n\t\tvar textWidth, textHeight;\n\n\t\tif(!this.iframe || this._expanding) return;\n\n\t\tthis._expanding = true;\n\n\t\tif(this.layout.name === \"pre-paginated\") {\n\t\t\twidth = this.layout.columnWidth;\n\t\t\theight = this.layout.height;\n\t\t}\n\t\t// Expand Horizontally\n\t\telse if(this.settings.axis === \"horizontal\") {\n\t\t\t// Get the width of the text\n\t\t\twidth = this.contents.textWidth();\n\n\t\t\tif (width % this.layout.pageWidth > 0) {\n\t\t\t\twidth = Math.ceil(width / this.layout.pageWidth) * this.layout.pageWidth;\n\t\t\t}\n\n\t\t\tif (this.settings.forceEvenPages) {\n\t\t\t\tcolumns = (width / this.layout.pageWidth);\n\t\t\t\tif ( this.layout.divisor > 1 &&\n\t\t\t\t\t\t this.layout.name === \"reflowable\" &&\n\t\t\t\t\t\t(columns % 2 > 0)) {\n\t\t\t\t\t// add a blank page\n\t\t\t\t\twidth += this.layout.pageWidth;\n\t\t\t\t}\n\t\t\t}\n\n\t\t} // Expand Vertically\n\t\telse if(this.settings.axis === \"vertical\") {\n\t\t\theight = this.contents.textHeight();\n\t\t\tif (this.settings.flow === \"paginated\" &&\n\t\t\t\theight % this.layout.height > 0) {\n\t\t\t\theight = Math.ceil(height / this.layout.height) * this.layout.height;\n\t\t\t}\n\t\t}\n\n\t\t// Only Resize if dimensions have changed or\n\t\t// if Frame is still hidden, so needs reframing\n\t\tif(this._needsReframe || width != this._width || height != this._height){\n\t\t\tthis.reframe(width, height);\n\t\t}\n\n\t\tthis._expanding = false;\n\t}\n\n\treframe(width, height) {\n\t\tvar size;\n\n\t\tif(isNumber(width)){\n\t\t\tthis.element.style.width = width + \"px\";\n\t\t\tthis.iframe.style.width = width + \"px\";\n\t\t\tthis._width = width;\n\t\t}\n\n\t\tif(isNumber(height)){\n\t\t\tthis.element.style.height = height + \"px\";\n\t\t\tthis.iframe.style.height = height + \"px\";\n\t\t\tthis._height = height;\n\t\t}\n\n\t\tlet widthDelta = this.prevBounds ? width - this.prevBounds.width : width;\n\t\tlet heightDelta = this.prevBounds ? height - this.prevBounds.height : height;\n\n\t\tsize = {\n\t\t\twidth: width,\n\t\t\theight: height,\n\t\t\twidthDelta: widthDelta,\n\t\t\theightDelta: heightDelta,\n\t\t};\n\n\t\tthis.pane && this.pane.render();\n\n\t\trequestAnimationFrame(() => {\n\t\t\tlet mark;\n\t\t\tfor (let m in this.marks) {\n\t\t\t\tif (this.marks.hasOwnProperty(m)) {\n\t\t\t\t\tmark = this.marks[m];\n\t\t\t\t\tthis.placeMark(mark.element, mark.range);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.onResize(this, size);\n\n\t\tthis.emit(EVENTS.VIEWS.RESIZED, size);\n\n\t\tthis.prevBounds = size;\n\n\t\tthis.elementBounds = bounds(this.element);\n\n\t}\n\n\n\tload(contents) {\n\t\tvar loading = new defer();\n\t\tvar loaded = loading.promise;\n\n\t\tif(!this.iframe) {\n\t\t\tloading.reject(new Error(\"No Iframe Available\"));\n\t\t\treturn loaded;\n\t\t}\n\n\t\tthis.iframe.onload = function(event) {\n\n\t\t\tthis.onLoad(event, loading);\n\n\t\t}.bind(this);\n\n\t\tif (this.settings.method === \"blobUrl\") {\n\t\t\tthis.blobUrl = createBlobUrl(contents, \"application/xhtml+xml\");\n\t\t\tthis.iframe.src = this.blobUrl;\n\t\t\tthis.element.appendChild(this.iframe);\n\t\t} else if(this.settings.method === \"srcdoc\"){\n\t\t\tthis.iframe.srcdoc = contents;\n\t\t\tthis.element.appendChild(this.iframe);\n\t\t} else {\n\n\t\t\tthis.element.appendChild(this.iframe);\n\n\t\t\tthis.document = this.iframe.contentDocument;\n\n\t\t\tif(!this.document) {\n\t\t\t\tloading.reject(new Error(\"No Document Available\"));\n\t\t\t\treturn loaded;\n\t\t\t}\n\n\t\t\tthis.iframe.contentDocument.open();\n\t\t\t// For Cordova windows platform\n\t\t\tif(window.MSApp && MSApp.execUnsafeLocalFunction) {\n\t\t\t\tvar outerThis = this;\n\t\t\t\tMSApp.execUnsafeLocalFunction(function () {\n\t\t\t\t\touterThis.iframe.contentDocument.write(contents);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.iframe.contentDocument.write(contents);\n\t\t\t}\n\t\t\tthis.iframe.contentDocument.close();\n\n\t\t}\n\n\t\treturn loaded;\n\t}\n\n\tonLoad(event, promise) {\n\n\t\tthis.window = this.iframe.contentWindow;\n\t\tthis.document = this.iframe.contentDocument;\n\n\t\tthis.contents = new Contents(this.document, this.document.body, this.section.cfiBase, this.section.index);\n\n\t\tthis.rendering = false;\n\n\t\tvar link = this.document.querySelector(\"link[rel='canonical']\");\n\t\tif (link) {\n\t\t\tlink.setAttribute(\"href\", this.section.canonical);\n\t\t} else {\n\t\t\tlink = this.document.createElement(\"link\");\n\t\t\tlink.setAttribute(\"rel\", \"canonical\");\n\t\t\tlink.setAttribute(\"href\", this.section.canonical);\n\t\t\tthis.document.querySelector(\"head\").appendChild(link);\n\t\t}\n\n\t\tthis.contents.on(EVENTS.CONTENTS.EXPAND, () => {\n\t\t\tif(this.displayed && this.iframe) {\n\t\t\t\tthis.expand();\n\t\t\t\tif (this.contents) {\n\t\t\t\t\tthis.layout.format(this.contents);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.contents.on(EVENTS.CONTENTS.RESIZE, (e) => {\n\t\t\tif(this.displayed && this.iframe) {\n\t\t\t\tthis.expand();\n\t\t\t\tif (this.contents) {\n\t\t\t\t\tthis.layout.format(this.contents);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tpromise.resolve(this.contents);\n\t}\n\n\tsetLayout(layout) {\n\t\tthis.layout = layout;\n\n\t\tif (this.contents) {\n\t\t\tthis.layout.format(this.contents);\n\t\t\tthis.expand();\n\t\t}\n\t}\n\n\tsetAxis(axis) {\n\n\t\tthis.settings.axis = axis;\n\n\t\tif(axis == \"horizontal\"){\n\t\t\tthis.element.style.flex = \"none\";\n\t\t} else {\n\t\t\tthis.element.style.flex = \"initial\";\n\t\t}\n\n\t\tthis.size();\n\n\t}\n\n\tsetWritingMode(mode) {\n\t\t// this.element.style.writingMode = writingMode;\n\t\tthis.writingMode = mode;\n\t}\n\n\taddListeners() {\n\t\t//TODO: Add content listeners for expanding\n\t}\n\n\tremoveListeners(layoutFunc) {\n\t\t//TODO: remove content listeners for expanding\n\t}\n\n\tdisplay(request) {\n\t\tvar displayed = new defer();\n\n\t\tif (!this.displayed) {\n\n\t\t\tthis.render(request)\n\t\t\t\t.then(function () {\n\n\t\t\t\t\tthis.emit(EVENTS.VIEWS.DISPLAYED, this);\n\t\t\t\t\tthis.onDisplayed(this);\n\n\t\t\t\t\tthis.displayed = true;\n\t\t\t\t\tdisplayed.resolve(this);\n\n\t\t\t\t}.bind(this), function (err) {\n\t\t\t\t\tdisplayed.reject(err, this);\n\t\t\t\t});\n\n\t\t} else {\n\t\t\tdisplayed.resolve(this);\n\t\t}\n\n\n\t\treturn displayed.promise;\n\t}\n\n\tshow() {\n\n\t\tthis.element.style.visibility = \"visible\";\n\n\t\tif(this.iframe){\n\t\t\tthis.iframe.style.visibility = \"visible\";\n\n\t\t\t// Remind Safari to redraw the iframe\n\t\t\tthis.iframe.style.transform = \"translateZ(0)\";\n\t\t\tthis.iframe.offsetWidth;\n\t\t\tthis.iframe.style.transform = null;\n\t\t}\n\n\t\tthis.emit(EVENTS.VIEWS.SHOWN, this);\n\t}\n\n\thide() {\n\t\t// this.iframe.style.display = \"none\";\n\t\tthis.element.style.visibility = \"hidden\";\n\t\tthis.iframe.style.visibility = \"hidden\";\n\n\t\tthis.stopExpanding = true;\n\t\tthis.emit(EVENTS.VIEWS.HIDDEN, this);\n\t}\n\n\toffset() {\n\t\treturn {\n\t\t\ttop: this.element.offsetTop,\n\t\t\tleft: this.element.offsetLeft\n\t\t}\n\t}\n\n\twidth() {\n\t\treturn this._width;\n\t}\n\n\theight() {\n\t\treturn this._height;\n\t}\n\n\tposition() {\n\t\treturn this.element.getBoundingClientRect();\n\t}\n\n\tlocationOf(target) {\n\t\tvar parentPos = this.iframe.getBoundingClientRect();\n\t\tvar targetPos = this.contents.locationOf(target, this.settings.ignoreClass);\n\n\t\treturn {\n\t\t\t\"left\": targetPos.left,\n\t\t\t\"top\": targetPos.top\n\t\t};\n\t}\n\n\tonDisplayed(view) {\n\t\t// Stub, override with a custom functions\n\t}\n\n\tonResize(view, e) {\n\t\t// Stub, override with a custom functions\n\t}\n\n\tbounds(force) {\n\t\tif(force || !this.elementBounds) {\n\t\t\tthis.elementBounds = bounds(this.element);\n\t\t}\n\n\t\treturn this.elementBounds;\n\t}\n\n\thighlight(cfiRange, data={}, cb, className = \"epubjs-hl\", styles = {}) {\n\t\tif (!this.contents) {\n\t\t\treturn;\n\t\t}\n\t\tconst attributes = Object.assign({\"fill\": \"yellow\", \"fill-opacity\": \"0.3\", \"mix-blend-mode\": \"multiply\"}, styles);\n\t\tlet range = this.contents.range(cfiRange);\n\n\t\tlet emitter = () => {\n\t\t\tthis.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n\t\t};\n\n\t\tdata[\"epubcfi\"] = cfiRange;\n\n\t\tif (!this.pane) {\n\t\t\tthis.pane = new Pane(this.iframe, this.element);\n\t\t}\n\n\t\tlet m = new Highlight(range, className, data, attributes);\n\t\tlet h = this.pane.addMark(m);\n\n\t\tthis.highlights[cfiRange] = { \"mark\": h, \"element\": h.element, \"listeners\": [emitter, cb] };\n\n\t\th.element.setAttribute(\"ref\", className);\n\t\th.element.addEventListener(\"click\", emitter);\n\t\th.element.addEventListener(\"touchstart\", emitter);\n\n\t\tif (cb) {\n\t\t\th.element.addEventListener(\"click\", cb);\n\t\t\th.element.addEventListener(\"touchstart\", cb);\n\t\t}\n\t\treturn h;\n\t}\n\n\tunderline(cfiRange, data={}, cb, className = \"epubjs-ul\", styles = {}) {\n\t\tif (!this.contents) {\n\t\t\treturn;\n\t\t}\n\t\tconst attributes = Object.assign({\"stroke\": \"black\", \"stroke-opacity\": \"0.3\", \"mix-blend-mode\": \"multiply\"}, styles);\n\t\tlet range = this.contents.range(cfiRange);\n\t\tlet emitter = () => {\n\t\t\tthis.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n\t\t};\n\n\t\tdata[\"epubcfi\"] = cfiRange;\n\n\t\tif (!this.pane) {\n\t\t\tthis.pane = new Pane(this.iframe, this.element);\n\t\t}\n\n\t\tlet m = new Underline(range, className, data, attributes);\n\t\tlet h = this.pane.addMark(m);\n\n\t\tthis.underlines[cfiRange] = { \"mark\": h, \"element\": h.element, \"listeners\": [emitter, cb] };\n\n\t\th.element.setAttribute(\"ref\", className);\n\t\th.element.addEventListener(\"click\", emitter);\n\t\th.element.addEventListener(\"touchstart\", emitter);\n\n\t\tif (cb) {\n\t\t\th.element.addEventListener(\"click\", cb);\n\t\t\th.element.addEventListener(\"touchstart\", cb);\n\t\t}\n\t\treturn h;\n\t}\n\n\tmark(cfiRange, data={}, cb) {\n\t\tif (!this.contents) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (cfiRange in this.marks) {\n\t\t\tlet item = this.marks[cfiRange];\n\t\t\treturn item;\n\t\t}\n\n\t\tlet range = this.contents.range(cfiRange);\n\t\tif (!range) {\n\t\t\treturn;\n\t\t}\n\t\tlet container = range.commonAncestorContainer;\n\t\tlet parent = (container.nodeType === 1) ? container : container.parentNode;\n\n\t\tlet emitter = (e) => {\n\t\t\tthis.emit(EVENTS.VIEWS.MARK_CLICKED, cfiRange, data);\n\t\t};\n\n\t\tif (range.collapsed && container.nodeType === 1) {\n\t\t\trange = new Range();\n\t\t\trange.selectNodeContents(container);\n\t\t} else if (range.collapsed) { // Webkit doesn't like collapsed ranges\n\t\t\trange = new Range();\n\t\t\trange.selectNodeContents(parent);\n\t\t}\n\n\t\tlet mark = this.document.createElement(\"a\");\n\t\tmark.setAttribute(\"ref\", \"epubjs-mk\");\n\t\tmark.style.position = \"absolute\";\n\n\t\tmark.dataset[\"epubcfi\"] = cfiRange;\n\n\t\tif (data) {\n\t\t\tObject.keys(data).forEach((key) => {\n\t\t\t\tmark.dataset[key] = data[key];\n\t\t\t});\n\t\t}\n\n\t\tif (cb) {\n\t\t\tmark.addEventListener(\"click\", cb);\n\t\t\tmark.addEventListener(\"touchstart\", cb);\n\t\t}\n\n\t\tmark.addEventListener(\"click\", emitter);\n\t\tmark.addEventListener(\"touchstart\", emitter);\n\n\t\tthis.placeMark(mark, range);\n\n\t\tthis.element.appendChild(mark);\n\n\t\tthis.marks[cfiRange] = { \"element\": mark, \"range\": range, \"listeners\": [emitter, cb] };\n\n\t\treturn parent;\n\t}\n\n\tplaceMark(element, range) {\n\t\tlet top, right, left;\n\n\t\tif(this.layout.name === \"pre-paginated\" ||\n\t\t\tthis.settings.axis !== \"horizontal\") {\n\t\t\tlet pos = range.getBoundingClientRect();\n\t\t\ttop = pos.top;\n\t\t\tright = pos.right;\n\t\t} else {\n\t\t\t// Element might break columns, so find the left most element\n\t\t\tlet rects = range.getClientRects();\n\n\t\t\tlet rect;\n\t\t\tfor (var i = 0; i != rects.length; i++) {\n\t\t\t\trect = rects[i];\n\t\t\t\tif (!left || rect.left < left) {\n\t\t\t\t\tleft = rect.left;\n\t\t\t\t\t// right = rect.right;\n\t\t\t\t\tright = Math.ceil(left / this.layout.props.pageWidth) * this.layout.props.pageWidth - (this.layout.gap / 2);\n\t\t\t\t\ttop = rect.top;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\telement.style.top = `${top}px`;\n\t\telement.style.left = `${right}px`;\n\t}\n\n\tunhighlight(cfiRange) {\n\t\tlet item;\n\t\tif (cfiRange in this.highlights) {\n\t\t\titem = this.highlights[cfiRange];\n\n\t\t\tthis.pane.removeMark(item.mark);\n\t\t\titem.listeners.forEach((l) => {\n\t\t\t\tif (l) {\n\t\t\t\t\titem.element.removeEventListener(\"click\", l);\n\t\t\t\t\titem.element.removeEventListener(\"touchstart\", l);\n\t\t\t\t};\n\t\t\t});\n\t\t\tdelete this.highlights[cfiRange];\n\t\t}\n\t}\n\n\tununderline(cfiRange) {\n\t\tlet item;\n\t\tif (cfiRange in this.underlines) {\n\t\t\titem = this.underlines[cfiRange];\n\t\t\tthis.pane.removeMark(item.mark);\n\t\t\titem.listeners.forEach((l) => {\n\t\t\t\tif (l) {\n\t\t\t\t\titem.element.removeEventListener(\"click\", l);\n\t\t\t\t\titem.element.removeEventListener(\"touchstart\", l);\n\t\t\t\t};\n\t\t\t});\n\t\t\tdelete this.underlines[cfiRange];\n\t\t}\n\t}\n\n\tunmark(cfiRange) {\n\t\tlet item;\n\t\tif (cfiRange in this.marks) {\n\t\t\titem = this.marks[cfiRange];\n\t\t\tthis.element.removeChild(item.element);\n\t\t\titem.listeners.forEach((l) => {\n\t\t\t\tif (l) {\n\t\t\t\t\titem.element.removeEventListener(\"click\", l);\n\t\t\t\t\titem.element.removeEventListener(\"touchstart\", l);\n\t\t\t\t};\n\t\t\t});\n\t\t\tdelete this.marks[cfiRange];\n\t\t}\n\t}\n\n\tdestroy() {\n\n\t\tfor (let cfiRange in this.highlights) {\n\t\t\tthis.unhighlight(cfiRange);\n\t\t}\n\n\t\tfor (let cfiRange in this.underlines) {\n\t\t\tthis.ununderline(cfiRange);\n\t\t}\n\n\t\tfor (let cfiRange in this.marks) {\n\t\t\tthis.unmark(cfiRange);\n\t\t}\n\n\t\tif (this.blobUrl) {\n\t\t\trevokeBlobUrl(this.blobUrl);\n\t\t}\n\n\t\tif(this.displayed){\n\t\t\tthis.displayed = false;\n\n\t\t\tthis.removeListeners();\n\t\t\tthis.contents.destroy();\n\n\t\t\tthis.stopExpanding = true;\n\t\t\tthis.element.removeChild(this.iframe);\n\n\t\t\tif (this.pane) {\n\t\t\t\tthis.pane.element.remove();\n\t\t\t\tthis.pane = undefined;\n\t\t\t}\n\n\t\t\tthis.iframe = undefined;\n\t\t\tthis.contents = undefined;\n\n\t\t\tthis._textWidth = null;\n\t\t\tthis._textHeight = null;\n\t\t\tthis._width = null;\n\t\t\tthis._height = null;\n\t\t}\n\n\t\t// this.element.style.height = \"0px\";\n\t\t// this.element.style.width = \"0px\";\n\t}\n}\n\nEventEmitter(IframeView.prototype);\n\nexport default IframeView;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}